<div class="list-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>receipt_long</mat-icon>
        Notas Fiscais
      </mat-card-title>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="navigateToCreate()">
          <mat-icon>add</mat-icon>
          Nova Nota Fiscal
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- Filtros -->
      <div class="filters-section">
        <form [formGroup]="filterForm" class="filters-form">
          <!-- subscriptSizing="dynamic" serve para remover o espaço de hint/erro quando não houver -->
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status">
              <mat-option [value]="null">Todos</mat-option>
              <mat-option [value]="InvoiceStatus.Open">Aberta</mat-option>
              <mat-option [value]="InvoiceStatus.Closed">Fechada</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Data Inicial</mat-label>
            <input matInput [matDatepicker]="pickerFrom" formControlName="createdFrom">
            <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
            <mat-datepicker #pickerFrom></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Data Final</mat-label>
            <input matInput [matDatepicker]="pickerTo" formControlName="createdTo">
            <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
            <mat-datepicker #pickerTo></mat-datepicker>
          </mat-form-field>

          <div class="checkbox-field">
            <mat-checkbox formControlName="includeCancelled">
              Incluir Canceladas
            </mat-checkbox>
          </div>

          <button mat-stroked-button type="button" (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Limpar
          </button>
        </form>
      </div>

      <!-- Loading -->
      <div *ngIf="loading" class="loading-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Carregando notas fiscais...</p>
      </div>

      <!-- quando não há notas fiscais -->
      <div *ngIf="!loading && invoices.length === 0" class="empty-state">
        <mat-icon class="mat-icon-lg">receipt_long</mat-icon>
        <p>Nenhuma nota fiscal encontrada</p>
        <button mat-raised-button color="primary" (click)="navigateToCreate()">
          <mat-icon>add</mat-icon>
          Criar Primeira Nota Fiscal
        </button>
      </div>

      <!-- Tabela -->
      <table *ngIf="!loading && invoices.length > 0" mat-table [dataSource]="invoices" class="invoices-table">
        <!-- Invoice Number -->
        <ng-container matColumnDef="invoiceNumber">
          <th mat-header-cell *matHeaderCellDef>Número</th>
          <td mat-cell *matCellDef="let invoice">
            <a class="invoice-link" (click)="navigateToDetail(invoice)">
              <strong>#{{ invoice.invoiceNumber }}</strong>
            </a>
          </td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let invoice">
            <mat-chip-set>
              <mat-chip [class.cancelled-chip]="invoice.cancelled" 
                        [class.open-chip]="!invoice.cancelled && invoice.status === InvoiceStatus.Open"
                        [class.closed-chip]="!invoice.cancelled && invoice.status === InvoiceStatus.Closed">
                <mat-icon *ngIf="invoice.cancelled">cancel</mat-icon>
                <mat-icon *ngIf="!invoice.cancelled && invoice.status === InvoiceStatus.Open">hourglass_empty</mat-icon>
                <mat-icon *ngIf="!invoice.cancelled && invoice.status === InvoiceStatus.Closed">check_circle</mat-icon>
                <label class="label-status">{{ invoice.cancelled ? 'Cancelada' : getStatusLabel(invoice.status) }}</label>
              </mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>

        <!-- Created At -->
        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>Criada em</th>
          <td mat-cell *matCellDef="let invoice">
            {{ formatDate(invoice.createdAt) }}
          </td>
        </ng-container>

        <!-- Printed At -->
        <ng-container matColumnDef="printedAt">
          <th mat-header-cell *matHeaderCellDef>Impressa em</th>
          <td mat-cell *matCellDef="let invoice">
            <span *ngIf="invoice.printedAt">{{ formatDate(invoice.printedAt) }}</span>
            <span *ngIf="!invoice.printedAt" class="not-printed">Não impressa</span>
          </td>
        </ng-container>

        <!-- Item Count -->
        <ng-container matColumnDef="itemCount">
          <th mat-header-cell *matHeaderCellDef>Itens</th>
          <td mat-cell *matCellDef="let invoice">
            {{ invoice.items.length }}
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Ações</th>
          <td mat-cell *matCellDef="let invoice">
            <button mat-icon-button 
                    [disabled]="!!invoice.printedAt || invoice.cancelled"
                    (click)="printInvoice(invoice)"
                    matTooltip="Imprimir"
                    [matTooltipDisabled]="!invoice.printedAt && !invoice.cancelled">
              <mat-icon>print</mat-icon>
            </button>
            <button mat-icon-button 
                    [disabled]="invoice.cancelled"
                    (click)="deleteInvoice(invoice)"
                    matTooltip="Cancelar"
                    color="warn">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</div>
